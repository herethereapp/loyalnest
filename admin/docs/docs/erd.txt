```mermaid
erDiagram
    %% Entities and Relationships for LoyalNest App
    %% Aligned with schema.sql (artifact_id: 3525b638-7e8e-4252-8aab-95823188cc26)
    %% Supports Shopify Plus (50,000+ customers, 1,000 orders/hour)
    %% Notes: Partitioned tables indicated, AES-256 encryption via pgcrypto, multilingual JSONB fields (en, es, fr)

    __diesel_schema_migrations {
        varchar version PK
        timestamp run_on
        -- Tracks schema migrations for all services
    }

    admin_users {
        integer id PK
        text username UK
        text password "AES-256 encrypted"
        text email UK "AES-256 encrypted"
        jsonb metadata "e.g., {'role': 'admin:full'}"
        timestamp created_at
        -- Managed by Admin Service (RBAC)
    }

    api_logs ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    api_logs {
        text id PK
        text merchant_id PK,FK
        text route
        text method
        integer status_code
        timestamp timestamp
        timestamp created_at
        -- Partitioned by merchant_id, 90-day retention
    }

    audit_logs }o--o| admin_users : "admin_user_id FK"
    audit_logs {
        uuid id PK
        integer admin_user_id FK
        text action
        text target_table
        uuid target_id
        timestamp timestamp
        timestamp created_at
        jsonb metadata "e.g., {'tier_name': 'Gold'}"
        -- 90-day retention
    }

    bonus_campaigns ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    bonus_campaigns {
        text campaign_id PK
        text merchant_id PK,FK
        text name
        text type
        numeric multiplier
        timestamp start_date
        timestamp end_date
        jsonb conditions "e.g., {'min_order_value': 100}"
        text status "active, inactive, expired"
        timestamp created_at
        timestamp updated_at
        -- Partitioned by merchant_id
    }

    customer_segments ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    customer_segments {
        text segment_id PK
        text merchant_id PK,FK
        text name
        jsonb rules "e.g., {'recency': '>=4'}"
        jsonb language "e.g., {'en': 'Champions', 'es': 'Campeones'}"
        timestamp created_at
        timestamp updated_at
        -- Partitioned by merchant_id, multilingual
    }

    customers ||--o{ merchants : "merchant_id FK"
    customers }o--o| vip_tiers : "vip_tier_id FK"
    customers {
        text customer_id PK
        text merchant_id FK
        text shopify_customer_id
        text email "AES-256 encrypted"
        text first_name
        text last_name
        integer points_balance
        text vip_tier_id FK
        jsonb rfm_score "e.g., {'recency': 5, 'score': 4.1}"
        text referral_url
        text state
        timestamp birthday
        jsonb email_preferences "e.g., {'marketing': true}"
        timestamp created_at
        timestamp updated_at
        text phone
        integer total_points_earned
        integer total_points_redeemed
        integer redeemed_rewards_count
        -- RFM scores, AES-256 encrypted email
    }

    email_events ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    email_events }o--o| emails : "email_id FK"
    email_events {
        text event_id PK
        text merchant_id PK,FK
        integer email_id FK
        text recipient_email "AES-256 encrypted"
        text event_type "sent, failed, opened, clicked"
        timestamp event_time
        jsonb metadata "e.g., {'template_id': '123'}"
        -- Partitioned by merchant_id, 90-day retention
    }

    email_templates ||--o{ merchants : "merchant_id FK"
    email_templates {
        text template_id PK
        text merchant_id FK
        text type "tier_change, nudge, welcome"
        text group
        text sub_type
        text subject
        jsonb body "e.g., {'en': 'Welcome!', 'es': '¡Bienvenido!'}"
        boolean is_enabled
        text banner_image
        timestamp created_at
        timestamp updated_at
        -- Multilingual JSONB
    }

    emails {
        integer id PK
        text subject
        text body
        timestamp sent_at
        integer recipient_count
        text status "sent, pending, failed"
        -- Email campaign tracking
    }

    import_logs ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    import_logs {
        text id PK
        text merchant_id PK,FK
        integer success_count
        integer fail_count
        text fail_reason
        timestamp created_at
        text source
        -- Partitioned by merchant_id
    }

    integrations ||--o{ merchants : "merchant_id FK"
    integrations {
        text integration_id PK
        text merchant_id FK
        text type "klaviyo, postscript, shopify_flow"
        text api_key "AES-256 encrypted"
        text status "active, inactive, error"
        jsonb prebuilt_flows "e.g., {'flow_id': '123'}"
        timestamp created_at
        timestamp updated_at
        jsonb settings
        -- Third-party integrations
    }

    merchants {
        text merchant_id PK
        text shopify_domain UK
        text plan_id
        timestamp billing_cycle_start
        text api_token "AES-256 encrypted"
        varchar status "active, suspended, trial"
        timestamp created_at
        timestamp updated_at
        jsonb brand_settings
        jsonb language "e.g., {'default': 'en'}"
        jsonb features_enabled "e.g., {'rfm_enabled': true}"
        jsonb staff_roles "e.g., {'admin:full': ['user_id_1']}"
        jsonb rate_limit_threshold "e.g., {'requests_per_hour': 1000}"
        -- Merchant configuration, multilingual
    }

    nudge_events ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    nudge_events }o--o| customers : "customer_id FK"
    nudge_events }o--o| nudges : "nudge_id FK"
    nudge_events {
        text event_id PK
        text customer_id FK "AES-256 encrypted"
        text merchant_id PK,FK
        text nudge_id FK
        text action "view, click, dismiss"
        timestamp created_at
        -- Partitioned by merchant_id, 90-day retention
    }

    nudges ||--o{ merchants : "merchant_id FK"
    nudges {
        text nudge_id PK
        text merchant_id FK
        text type "at-risk, loyal, new, inactive, referral"
        jsonb title "e.g., {'en': 'Stay Active!', 'es': '¡Mantente Activo!'}"
        jsonb description "e.g., {'en': 'Shop now!', 'es': '¡Compra ahora!'}"
        text icon_url
        boolean is_enabled
        timestamp created_at
        timestamp updated_at
        -- Multilingual JSONB
    }

    plans {
        text plan_id PK
        text name
        integer order_limit
        numeric base_price
        numeric additional_order_rate
        jsonb features "e.g., {'rfm_basic': true}"
        -- Pricing plans
    }

    points_transactions ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    points_transactions ||--o{ customers : "customer_id FK"
    points_transactions {
        text transaction_id PK
        text customer_id FK
        text merchant_id PK,FK
        text type "earn, redeem, expire, adjust"
        integer points
        text source
        text order_id
        timestamp created_at
        -- Partitioned by merchant_id
    }

    program_settings ||--o{ merchants : "merchant_id FK"
    program_settings {
        text merchant_id PK,FK
        text points_currency_singular
        text points_currency_plural
        integer expiry_days
        boolean allow_guests
        jsonb branding
        jsonb config "e.g., {'grace_period_days': 30}"
        jsonb rfm_thresholds "e.g., {'recency': {'5': {'maxDays': 7}}}"
        -- RFM and loyalty configuration
    }

    referral_links ||--o{ merchants : "merchant_id FK"
    referral_links ||--o{ customers : "advocate_customer_id FK"
    referral_links {
        text referral_link_id PK
        text advocate_customer_id FK
        text merchant_id FK
        text referral_code "AES-256 encrypted"
        timestamp created_at
        timestamp last_viewed_at
        -- Referral link tracking
    }

    referrals ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    referrals ||--o{ customers : "advocate_customer_id FK"
    referrals ||--o{ customers : "friend_customer_id FK"
    referrals }o--o| rewards : "reward_id FK"
    referrals }o--o| referral_links : "referral_link_id FK"
    referrals {
        text referral_id PK
        text merchant_id PK,FK
        text advocate_customer_id FK
        text friend_customer_id FK
        text referral_link_id FK
        text status "pending, completed, expired"
        text notification_status "sent, failed, pending"
        text reward_id FK
        text order_id
        timestamp created_at
        timestamp updated_at
        text source
        text campaign_id
        jsonb metadata "e.g., {'channel': 'sms'}"
        -- Partitioned by merchant_id
    }

    reward_redemptions ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    reward_redemptions ||--o{ customers : "customer_id FK"
    reward_redemptions ||--o{ rewards : "reward_id FK"
    reward_redemptions }o--o| bonus_campaigns : "campaign_id FK"
    reward_redemptions {
        text redemption_id PK
        text customer_id FK
        text reward_id FK
        text merchant_id PK,FK
        text campaign_id FK
        text discount_code
        integer points_spent
        text status "issued, used, expired"
        timestamp issued_at
        timestamp expires_at
        jsonb metadata "e.g., {'rfm_segment': 'Champions'}"
        -- Partitioned by merchant_id
    }

    rewards ||--o{ merchants : "merchant_id FK"
    rewards {
        text reward_id PK
        text merchant_id FK
        text type "discount, free_shipping, gift"
        integer points_cost
        numeric value
        boolean is_combinable
        timestamp created_at
        timestamp updated_at
        text category
        boolean is_public
        text platform "online_store, pos"
        -- Reward configurations
    }

    shopify_sessions {
        integer id PK
        text session_id UK
        text shop
        text state
        boolean is_online
        text scope
        text access_token "AES-256 encrypted"
        timestamp expires_at
        jsonb online_access_info
        timestamp created_at
        timestamp updated_at
        -- Shopify OAuth sessions
    }

    usage_records ||--o{ merchants : "merchant_id FK"
    usage_records {
        integer id PK
        text merchant_id FK
        date period_start
        date period_end
        integer order_count
        timestamp created_at
        -- Billing and usage tracking
    }

    vip_tiers ||--o{ merchants : "merchant_id FK"
    vip_tiers }o--o| rewards : "entry_reward_id FK"
    vip_tiers {
        text vip_tier_id PK
        text merchant_id FK
        text name
        text threshold_type "points, spend, orders"
        numeric threshold_value
        numeric earning_multiplier
        text entry_reward_id FK
        jsonb perks "e.g., {'discount': 10}"
        timestamp created_at
        timestamp updated_at
        integer tier_level
        -- VIP tier configurations
    }

    gdpr_requests ||--o{ merchants : "merchant_id FK, partitioned by merchant_id"
    gdpr_requests }o--o| customers : "customer_id FK"
    gdpr_requests {
        text request_id PK
        text merchant_id PK,FK
        text customer_id FK
        text request_type "data_request, redact"
        text status "pending, completed, failed"
        timestamp retention_expires_at
        timestamp created_at
        timestamp updated_at
        jsonb metadata "e.g., {'origin': 'widget'}"
        -- Partitioned by merchant_id, 90-day retention
    }

    rfm_segment_counts ||--o{ merchants : "merchant_id"
    rfm_segment_counts ||--o{ customer_segments : "name"
    rfm_segment_counts {
        text merchant_id
        text segment_name
        bigint customer_count
        timestamp last_refreshed
        -- Materialized view, refreshed daily
    }

    %% Relationships summary
    %% merchants is central, referenced by most tables
    %% customers links to vip_tiers, points_transactions, nudge_events, referrals, reward_redemptions, gdpr_requests
    %% Partitioned tables: api_logs, bonus_campaigns, customer_segments, email_events, nudge_events, points_transactions, referrals, reward_redemptions, import_logs, gdpr_requests
    %% Encrypted fields: customers.email, merchants.api_token, integrations.api_key, shopify_sessions.access_token, referral_links.referral_code, nudge_events.customer_id
    %% Multilingual JSONB: email_templates.body, nudges.title, nudges.description, program_settings.config, customer_segments.language, merchants.language
```